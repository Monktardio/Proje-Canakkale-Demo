<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Proje √áanakkale ‚Äì Demo (√úretici + Devlet)</title>

<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --accent:#0f3d5e;
    --danger:#b91c1c;
    --ok:#065f46;
    --bad:#7f1d1d;
    --warnbg:#fff7ed;
    --warnline:#fed7aa;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --radius:16px;
  }

  *{box-sizing:border-box}

  /* ‚úÖ MOBILE SCROLL SAFETY */
  html, body{
    height:100%;
    overflow-x:hidden;
  }
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    margin:0;
    padding:40px;
    color:var(--text);
    overflow-y:auto;
    -webkit-overflow-scrolling:touch;
    touch-action: pan-y;
  }

  .card{
    max-width:1100px;
    margin:0 auto 18px auto;
    background:var(--card);
    border-radius:var(--radius);
    padding:32px;
    box-shadow:var(--shadow);
  }
  h1{margin:0 0 6px 0; letter-spacing:-.2px; font-size:44px; line-height:1.05;}
  .sub{color:var(--muted);margin:0 0 18px 0; font-size:16px; line-height:1.35}
  label{display:block;margin-top:14px;font-weight:650}

  input, select{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    border:1px solid var(--line);
    border-radius:10px;
    font-size:14px;
    background:#fff;
    color:var(--text);
  }
  input::placeholder{font-size:12px;color:#9ca3af}
  input[readonly]{background:#f3f4f6}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  @media (max-width:920px){ .row3{grid-template-columns:1fr} }

  button{
    margin-top:18px;
    padding:12px 14px;
    border:none;
    border-radius:12px;
    font-size:15px;
    font-weight:750;
    cursor:pointer;
  }
  .btn-primary{background:var(--accent);color:#fff;width:100%}
  .btn-danger{background:var(--danger);color:#fff;width:100%}
  .btn-ghost{background:#eef2f7;color:#111827}
  .btn-inline{width:auto}

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    margin-bottom:8px;
  }
  .pill{
    display:flex;
    align-items:center;
    gap:10px;
    background:#eef2ff;
    color:#1f2a44;
    padding:10px 14px;
    border-radius:999px;
    line-height:1.1;
    font-weight:750;
    font-size:13px;
    white-space:nowrap;
  }
  .pill svg{width:18px;height:18px;flex:0 0 18px}
  .pill .meta{display:flex;flex-direction:column;gap:2px}
  .pill .meta .k{font-size:11px;color:#4b5563;font-weight:800;letter-spacing:.2px}
  .pill .meta .v{font-size:13px;color:#111827;font-weight:800}

  .note{
    margin-top:14px;
    background:var(--warnbg);
    border:1px solid var(--warnline);
    padding:12px 14px;
    border-radius:12px;
    font-size:14px;
  }
  .statusBox{margin-top:16px;padding:14px;border-radius:12px;font-weight:750}
  .ok{background:#dcfce7;color:var(--ok)}
  .bad{background:#fee2e2;color:var(--bad)}
  .muted{color:var(--muted)}
  .actionsRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  .rightActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

  .filters{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .filters input, .filters select{width:auto;min-width:220px}

  table{width:100%;border-collapse:collapse;margin-top:16px}
  th, td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
  th{background:#f3f4f6}
  tr:hover{background:#f9fafb;cursor:pointer}
  .status-ok{color:var(--ok);font-weight:800}
  .status-bad{color:var(--bad);font-weight:800}

  /* ‚úÖ MODAL SCROLL FIX (Android/Chrome safe) */
  .modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.42);
    display:none;
    align-items:flex-start;     /* not center */
    justify-content:center;
    padding:18px;
    z-index:50;
    overflow:auto;              /* allow scroll in overlay */
    -webkit-overflow-scrolling:touch;
    touch-action: pan-y;
  }
  .modalContent{
    background:#fff;
    width:100%;
    max-width:780px;
    border-radius:16px;
    padding:22px;
    box-shadow:0 20px 50px rgba(0,0,0,.18);
    max-height:calc(100vh - 36px);
    overflow:auto;
    -webkit-overflow-scrolling:touch;
  }
  .modalHeader{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .modalHeader h2{margin:0}
  .hr{height:1px;background:var(--line);margin:14px 0}
  .kv{display:grid;grid-template-columns:240px 1fr;gap:8px 12px}
  @media (max-width:720px){ .kv{grid-template-columns:1fr} }
  .k{color:var(--muted);font-weight:650}
  .v{font-weight:650}

  /* Date input with icon inside */
  .dateWrap{position:relative;margin-top:6px;}
  .dateWrap input[type="text"]{margin-top:0;padding-right:44px}
  .dateIconBtn{
    position:absolute; right:10px; top:50%; transform:translateY(-50%);
    width:28px;height:28px; border:none; background:transparent;
    padding:0;margin:0; display:flex; align-items:center; justify-content:center;
    cursor:pointer; border-radius:8px;
  }
  .dateIconBtn:hover{ background:#f3f4f6; }
  .dateIconBtn:active{ background:#e5e7eb; }
  .dateIconBtn svg{ width:18px;height:18px; stroke:var(--muted); }
  .hiddenDate{position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;}

  /* Mobile */
  @media (max-width:820px){
    body{padding:18px}
    .card{padding:22px}
    h1{font-size:34px; line-height:1.05}
    .sub{font-size:15px}

    .topbar{flex-direction:column; align-items:flex-start}
    .rightActions{width:100%; justify-content:flex-start}
    .pill{padding:9px 12px; max-width:100%}
    .filters input, .filters select{min-width:0; width:100%}

    /* Table -> cards */
    table thead{display:none}
    table, tbody, tr, td{display:block; width:100%}
    tr{
      border:1px solid var(--line);
      border-radius:14px;
      margin-top:12px;
      overflow:hidden;
      background:#fff;
      touch-action: pan-y;
    }
    tr:hover{background:#fff}

    td{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      touch-action: pan-y;
    }
    td:last-child{border-bottom:none}
    td::before{
      content: attr(data-label);
      flex:0 0 42%;
      max-width:42%;
      font-weight:800;
      color:var(--muted);
      white-space:nowrap;
    }

    .stackRight{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      width:100%;
      min-width:0;
    }
    .line1{
      width:100%;
      white-space:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      text-align:right;
    }
    .line1::-webkit-scrollbar{display:none}
    .line2{
      width:100%;
      white-space:nowrap;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      text-align:right;
      font-size:12px;
      color:var(--muted);
    }
    .line2::-webkit-scrollbar{display:none}

    .oneLineRight{
      flex:1 1 auto;
      min-width:0;
      text-align:right;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
  }

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#fff;
    font-size:13px;
    font-weight:700;
  }
  .chip.bad{background:#fff1f2;border-color:#fecdd3;color:#7f1d1d}
  .chip.ok{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginView">
  <div class="topbar">
    <div>
      <h1>Giri≈ü</h1>
      <p class="sub">Demo ama√ßlƒ± rol bazlƒ± giri≈ü (√úretici / Devlet).</p>
    </div>
    <div class="pill" aria-label="Proje √áanakkale">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z"/>
      </svg>
      <div class="meta">
        <div class="k">PROJE</div>
        <div class="v">√áanakkale</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>Kullanƒ±cƒ± Kodu</label>
      <input id="loginCode" placeholder="√ñrn: TR-17-001 veya DEVLET" />
    </div>
    <div>
      <label>≈ûifre</label>
      <input id="loginPw" type="password" placeholder="≈ûifre" />
    </div>
  </div>

  <button class="btn-primary" onclick="doLogin()">Giri≈ü</button>

  <div class="note">
    <strong>Login:</strong><br>
    √úretici: <code>TR-17-001</code> / <code>Ezine</code><br>
    Devlet: <code>DEVLET</code> / <code>Devlet</code>
  </div>
</div>

<!-- PRODUCER VIEW -->
<div class="card" id="producerView" style="display:none">
  <div class="topbar">
    <div>
      <h1>√úretici Kayƒ±t Merkezi</h1>
      <p class="sub">Paketleme tamamla i≈üleminden sonra kayƒ±t kilitlenir ve deƒüi≈ütirilemez.</p>
    </div>
    <div class="rightActions">
      <div class="pill" id="producerPill">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21a8 8 0 0 0-16 0"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        <div class="meta">
          <div class="k">√úRETƒ∞Cƒ∞</div>
          <div class="v" id="producerNamePill">-</div>
        </div>
      </div>
      <button class="btn-ghost btn-inline" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úretici Adƒ±</label>
      <input id="pName" readonly />
    </div>
    <div>
      <label>√úretici Kodu</label>
      <input id="pCode" readonly />
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úr√ºn Adƒ±</label>
      <input id="pProduct" placeholder="√ñrn: Ezine Peyniri" />
    </div>
    <div>
      <label>Parti No</label>
      <input id="pBatch" placeholder="√ñrn: EZ-2026-01" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úretim Yeri (ƒ∞l√ße / √áanakkale)</label>
      <input id="pPlace" placeholder="√ñrn: Ezine / √áanakkale" />
    </div>
    <div>
      <label>STT (Son T√ºketim Tarihi)</label>
      <div class="dateWrap">
        <input
          id="pSttText"
          type="text"
          inputmode="numeric"
          placeholder="√ñrn: 02.03.2027"
          maxlength="10"
          oninput="handleDateTyping(this, 'pSttPicker');"
          onblur="normalizeDateText(this, 'pSttPicker');"
        />
        <input class="hiddenDate" id="pSttPicker" type="date"
               onchange="syncFromPicker('pSttPicker','pSttText');" />
        <button type="button" class="dateIconBtn" onclick="openPicker('pSttPicker')" aria-label="Takvim">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M8 2v3M16 2v3"/>
            <path d="M3 8h18"/>
            <rect x="3" y="5" width="18" height="17" rx="2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úretim Tarihi</label>
      <div class="dateWrap">
        <input
          id="pProdDateText"
          type="text"
          inputmode="numeric"
          placeholder="√ñrn: 05.03.2026"
          maxlength="10"
          oninput="handleDateTyping(this, 'pProdDatePicker'); calcMonths(); refreshLiveRules();"
          onblur="normalizeDateText(this, 'pProdDatePicker'); calcMonths(); refreshLiveRules();"
        />
        <input class="hiddenDate" id="pProdDatePicker" type="date"
               onchange="syncFromPicker('pProdDatePicker','pProdDateText'); calcMonths(); refreshLiveRules();" />
        <button type="button" class="dateIconBtn" onclick="openPicker('pProdDatePicker')" aria-label="Takvim">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M8 2v3M16 2v3"/>
            <path d="M3 8h18"/>
            <rect x="3" y="5" width="18" height="17" rx="2"/>
          </svg>
        </button>
      </div>
    </div>

    <div>
      <label>Paketleme Tarihi</label>
      <div class="dateWrap">
        <input
          id="pPackDateText"
          type="text"
          inputmode="numeric"
          placeholder="√ñrn: 05.12.2026"
          maxlength="10"
          oninput="handleDateTyping(this, 'pPackDatePicker'); calcMonths(); refreshLiveRules();"
          onblur="normalizeDateText(this, 'pPackDatePicker'); calcMonths(); refreshLiveRules();"
        />
        <input class="hiddenDate" id="pPackDatePicker" type="date"
               onchange="syncFromPicker('pPackDatePicker','pPackDateText'); calcMonths(); refreshLiveRules();" />
        <button type="button" class="dateIconBtn" onclick="openPicker('pPackDatePicker')" aria-label="Takvim">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M8 2v3M16 2v3"/>
            <path d="M3 8h18"/>
            <rect x="3" y="5" width="18" height="17" rx="2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div class="row3">
    <div>
      <label>Koyun S√ºt√º (%)</label>
      <input id="pSheep" type="number" min="0" max="100" step="1" placeholder="√ñrn: 40" oninput="refreshLiveRules()" />
    </div>
    <div>
      <label>Ke√ßi S√ºt√º (%)</label>
      <input id="pGoat" type="number" min="0" max="100" step="1" placeholder="√ñrn: 42" oninput="refreshLiveRules()" />
    </div>
    <div>
      <label>ƒ∞nek S√ºt√º (%)</label>
      <input id="pCow" type="number" min="0" max="100" step="1" placeholder="√ñrn: 18" oninput="refreshLiveRules()" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>Olgunla≈üma S√ºresi (ay)</label>
      <input id="pMonths" readonly placeholder="Tarihlerden otomatik hesaplanƒ±r" />
    </div>
    <div>
      <label>Toplam S√ºt Oranƒ± (%)</label>
      <input id="pTotalMilk" readonly placeholder="Koyun + Ke√ßi + ƒ∞nek" />
    </div>
  </div>

  <div class="note">
    <strong>Otomatik Kurallar:</strong><br>
    ‚Ä¢ Olgunla≈üma s√ºresi minimum <strong>8 ay</strong><br>
    ‚Ä¢ √úretim tarihi yalnƒ±zca <strong>Mart‚ÄìAƒüustos</strong><br>
    ‚Ä¢ Koyun: <strong>%35‚Äì%45</strong> ‚Ä¢ Ke√ßi: <strong>min %40</strong> ‚Ä¢ ƒ∞nek: <strong>max %25</strong>
  </div>

  <div class="chips" id="liveChips"></div>

  <button class="btn-danger" id="finalizeBtn" onclick="finalizeRecord()">Paketleme tamamla</button>

  <div id="producerResult"></div>
</div>

<!-- STATE VIEW -->
<div class="card" id="stateView" style="display:none">
  <div class="topbar">
    <div>
      <h1>Devlet ƒ∞zleme Paneli</h1>
      <p class="sub">Veriler otomatik kurallara g√∂re olu≈üturulur. Manuel deƒüerlendirme / m√ºdahale yoktur.</p>
    </div>
    <div class="rightActions">
      <div class="pill" id="statePill">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 3l8 5v6c0 5-3.5 8-8 9-4.5-1-8-4-8-9V8l8-5z"/>
          <path d="M9 12l2 2 4-4"/>
        </svg>
        <div class="meta">
          <div class="k">KURUM</div>
          <div class="v">Devlet</div>
        </div>
      </div>
      <button class="btn-ghost btn-inline" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="filters">
    <input id="q" placeholder="Ara: √ºretici, √ºr√ºn, parti, referans, yer, STT" onkeyup="renderTable()" />
    <select id="statusFilter" onchange="renderTable()">
      <option value="">T√ºm Durumlar</option>
      <option value="Uygun">üü¢ Uygun</option>
      <option value="Uygunsuz">üî¥ Uygunsuz</option>
    </select>
    <select id="ageFilter" onchange="renderTable()">
      <option value="">Olgunla≈üma (T√ºm√º)</option>
      <option value="lt8">&lt; 8 ay</option>
      <option value="gte8">‚â• 8 ay</option>
    </select>
    <select id="seasonFilter" onchange="renderTable()">
      <option value="">Sezon (T√ºm√º)</option>
      <option value="in">Mart‚ÄìAƒüustos</option>
      <option value="out">Sezon dƒ±≈üƒ±</option>
    </select>
  </div>

  <div class="actionsRow">
    <button class="btn-ghost btn-inline" onclick="exportCSV()">CSV Dƒ±≈üa Aktar</button>
    <button class="btn-ghost btn-inline" onclick="exportPDF()">PDF ƒ∞ndir (Otomatik)</button>
    <span class="small">PDF: tek tƒ±k ile indir.</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Referans</th>
        <th>√úretici</th>
        <th>√úr√ºn</th>
        <th>Parti</th>
        <th>√úretim Yeri</th>
        <th>√úretim</th>
        <th>STT</th>
        <th>Ay</th>
        <th>Durum</th>
        <th>Finalizasyon</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <p class="small muted" id="countInfo"></p>
</div>

<!-- DETAIL MODAL -->
<div class="modal" id="modal" onclick="if(event.target.id==='modal') closeModal()">
  <div class="modalContent" id="modalContent"></div>
</div>

<!-- ‚úÖ PDF libs for direct download -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.29/dist/jspdf.plugin.autotable.min.js"></script>

<script>
/* USERS */
const USERS = [
  { code:"TR-17-001", pw:"Ezine",  role:"producer", name:"Proje Canakkale" },
  { code:"DEVLET",    pw:"Devlet", role:"state",    name:"Tarƒ±m ve Gƒ±da Otoritesi" }
];

/* STORAGE */
const STORE_KEY = "pc_demo_records_rules_v2";
let currentUser = null;
let records = loadRecords();

/* UTIL */
function demoHash(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return ("0000000" + h.toString(16)).slice(-8).toUpperCase();
}
function pad4(n){ return String(n).padStart(4,"0"); }
function buildReference({code, batch, year}){
  const short = code.replace("TR-","").replaceAll("-","");
  const seed = demoHash(code + "|" + batch + "|" + year);
  const seq = parseInt(seed.slice(-3), 16) % 10000;
  return `PC-${short}-${year}-${pad4(seq)}`;
}

/* DATE helpers */
function openPicker(pickerId){
  const el = document.getElementById(pickerId);
  if(!el) return;
  if(typeof el.showPicker === "function") el.showPicker();
  else { el.focus(); el.click(); }
}
function handleDateTyping(textEl, pickerId){
  let digits = textEl.value.replace(/\D/g,"").slice(0,8); // ddmmyyyy
  let out = "";
  if(digits.length <= 2) out = digits;
  else if(digits.length <= 4) out = digits.slice(0,2) + "." + digits.slice(2);
  else out = digits.slice(0,2) + "." + digits.slice(2,4) + "." + digits.slice(4);
  textEl.value = out;

  const dt = parseTRDate(out);
  if(dt) document.getElementById(pickerId).value = toISODate(dt);
}
function normalizeDateText(textEl, pickerId){
  const dt = parseFlexibleDate(textEl.value);
  if(dt){
    textEl.value = toTRDate(dt);
    document.getElementById(pickerId).value = toISODate(dt);
  }
}
function parseTRDate(s){
  const m = String(s||"").trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const d = +m[1], mo = +m[2], y = +m[3];
  const dt = new Date(y, mo-1, d);
  if(dt.getFullYear()===y && (dt.getMonth()+1)===mo && dt.getDate()===d) return dt;
  return null;
}
function parseFlexibleDate(s){
  if(!s) return null;
  const v = String(s).trim();
  let m = v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    const dt=new Date(y, mo-1, d);
    if(dt.getFullYear()===y && (dt.getMonth()+1)===mo && dt.getDate()===d) return dt;
    return null;
  }
  return parseTRDate(v);
}
function toTRDate(dt){
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const yy = dt.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function toISODate(dt){
  const yy = dt.getFullYear();
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}
function syncFromPicker(pickerId, textId){
  const p = document.getElementById(pickerId).value; // yyyy-mm-dd
  const dt = parseFlexibleDate(p);
  if(dt) document.getElementById(textId).value = toTRDate(dt);
}

/* RULES */
function monthFromTR(trDate){
  const dt = parseFlexibleDate(trDate);
  return dt ? (dt.getMonth()+1) : null; // 1..12
}
function isSeasonOk(prodTR){
  const m = monthFromTR(prodTR);
  if(m == null) return null;
  return (m >= 3 && m <= 8);
}

function calcMonths(){
  const prod = parseFlexibleDate(document.getElementById("pProdDateText").value);
  const pack = parseFlexibleDate(document.getElementById("pPackDateText").value);

  if(!prod || !pack){
    document.getElementById("pMonths").value = "";
    return null;
  }
  const months = Math.floor((pack - prod) / (1000*60*60*24*30));
  document.getElementById("pMonths").value = months;
  return months;
}

function calcMilkTotal(){
  const s = parseFloat(document.getElementById("pSheep").value);
  const g = parseFloat(document.getElementById("pGoat").value);
  const c = parseFloat(document.getElementById("pCow").value);
  const vals = [s,g,c].map(v => Number.isFinite(v) ? v : 0);
  const any = [s,g,c].some(v => Number.isFinite(v));
  const total = vals[0]+vals[1]+vals[2];
  document.getElementById("pTotalMilk").value = any ? total : "";
  return {s, g, c, total, any};
}

function evaluateRules(form){
  const reasonsBad = [];
  const reasonsOk = [];

  if(Number.isFinite(form.sheep)){
    if(form.sheep >= 35 && form.sheep <= 45) reasonsOk.push("Koyun s√ºt√º oranƒ± %35‚Äì%45 aralƒ±ƒüƒ±nda.");
    else reasonsBad.push("Koyun s√ºt√º oranƒ± %35‚Äì%45 aralƒ±ƒüƒ± dƒ±≈üƒ±nda.");
  } else reasonsBad.push("Koyun s√ºt√º oranƒ± girilmedi.");

  if(Number.isFinite(form.goat)){
    if(form.goat >= 40) reasonsOk.push("Ke√ßi s√ºt√º oranƒ± minimum %40 ≈üartƒ±nƒ± kar≈üƒ±lƒ±yor.");
    else reasonsBad.push("Ke√ßi s√ºt√º oranƒ± minimum %40 ≈üartƒ±nƒ± kar≈üƒ±lamƒ±yor.");
  } else reasonsBad.push("Ke√ßi s√ºt√º oranƒ± girilmedi.");

  if(Number.isFinite(form.cow)){
    if(form.cow <= 25) reasonsOk.push("ƒ∞nek s√ºt√º oranƒ± maksimum %25 sƒ±nƒ±rƒ±nƒ± a≈ümƒ±yor.");
    else reasonsBad.push("ƒ∞nek s√ºt√º oranƒ± maksimum %25 sƒ±nƒ±rƒ±nƒ± a≈üƒ±yor.");
  } else reasonsBad.push("ƒ∞nek s√ºt√º oranƒ± girilmedi.");

  let totalWarning = null;
  if(form.milkAny){
    if(Math.round(form.total) !== 100){
      totalWarning = "Uyarƒ±: S√ºt oranlarƒ± toplamƒ± %100 deƒüil.";
    }
  }

  if(form.prodDate && form.packDate){
    if(form.packDate < form.prodDate){
      reasonsBad.push("Paketleme tarihi, √ºretim tarihinden √∂nce olamaz.");
    }
  }

  const seasonOk = isSeasonOk(form.prodDateTR);
  if(seasonOk === true) reasonsOk.push("√úretim tarihi izin verilen √ºretim sezonu i√ßerisindedir (Mart‚ÄìAƒüustos).");
  else if(seasonOk === false) reasonsBad.push("√úretim tarihi izin verilen √ºretim sezonu dƒ±≈üƒ±ndadƒ±r (Mart‚ÄìAƒüustos).");

  if(Number.isFinite(form.months)){
    if(form.months >= 8) reasonsOk.push("Olgunla≈üma s√ºresi minimum 8 ay ≈üartƒ±nƒ± kar≈üƒ±lƒ±yor.");
    else reasonsBad.push("Olgunla≈üma s√ºresi minimum 8 ay ≈üartƒ±nƒ± kar≈üƒ±lamƒ±yor.");
  } else reasonsBad.push("Olgunla≈üma s√ºresi hesaplanamadƒ± (tarihler eksik/yanlƒ±≈ü).");

  const status = reasonsBad.length ? "Uygunsuz" : "Uygun";
  return { status, reasonsBad, reasonsOk, totalWarning, seasonOk };
}

/* LIVE chips (producer) */
function refreshLiveRules(){
  const months = calcMonths();
  const prodTR = document.getElementById("pProdDateText").value;
  const packTR = document.getElementById("pPackDateText").value;

  const prodDate = parseFlexibleDate(prodTR);
  const packDate = parseFlexibleDate(packTR);

  const sheep = parseFloat(document.getElementById("pSheep").value);
  const goat  = parseFloat(document.getElementById("pGoat").value);
  const cow   = parseFloat(document.getElementById("pCow").value);
  const milk = calcMilkTotal();

  const res = evaluateRules({
    prodDateTR: prodTR,
    prodDate,
    packDate,
    months,
    sheep: Number.isFinite(sheep) ? sheep : NaN,
    goat:  Number.isFinite(goat)  ? goat  : NaN,
    cow:   Number.isFinite(cow)   ? cow   : NaN,
    total: milk.total,
    milkAny: milk.any
  });

  const chips = [];
  if(Number.isFinite(sheep)) chips.push({ ok:(sheep>=35 && sheep<=45), t:`Koyun %35‚Äì45 (${sheep}%)` });
  if(Number.isFinite(goat))  chips.push({ ok:(goat>=40), t:`Ke√ßi ‚â•%40 (${goat}%)` });
  if(Number.isFinite(cow))   chips.push({ ok:(cow<=25), t:`ƒ∞nek ‚â§%25 (${cow}%)` });
  if(Number.isFinite(months)) chips.push({ ok:(months>=8), t:`Olgunla≈üma ‚â•8 ay (${months})` });

  const seasonOk = isSeasonOk(prodTR);
  if(seasonOk === true) chips.push({ ok:true, t:`Sezon: Mart‚ÄìAƒüustos` });
  else if(seasonOk === false) chips.push({ ok:false, t:`Sezon dƒ±≈üƒ±` });

  if(res.totalWarning) chips.push({ ok:false, t:`Uyarƒ±: Toplam %${Math.round(milk.total)}` });

  const el = document.getElementById("liveChips");
  el.innerHTML = chips.map(c => `<span class="chip ${c.ok?'ok':'bad'}">${c.ok?'‚úÖ':'‚ùå'} ${c.t}</span>`).join("");
}

/* AUTH */
function doLogin(){
  const c = document.getElementById("loginCode").value.trim();
  const p = document.getElementById("loginPw").value;
  const u = USERS.find(x => x.code === c && x.pw === p);
  if(!u){ alert("Hatalƒ± giri≈ü"); return; }
  currentUser = u;

  document.getElementById("loginView").style.display = "none";
  if(u.role === "producer"){
    document.getElementById("producerView").style.display = "block";
    document.getElementById("pName").value = u.name;
    document.getElementById("pCode").value = u.code;
    document.getElementById("producerNamePill").textContent = u.name;
    resetProducerForm();
  }else{
    document.getElementById("stateView").style.display = "block";
    renderTable();
  }
}
function logout(){
  currentUser = null;
  document.getElementById("loginCode").value = "";
  document.getElementById("loginPw").value = "";
  document.getElementById("producerView").style.display = "none";
  document.getElementById("stateView").style.display = "none";
  closeModal();
  document.getElementById("loginView").style.display = "block";
}

/* RECORD MODEL */
function makeRecord(data){
  const payload = JSON.stringify(data);
  const hash = demoHash(payload);
  const year = (data.prodDate && data.prodDate.includes(".")) ? data.prodDate.split(".")[2] : String(new Date().getFullYear());
  const ref = buildReference({code:data.code, batch:data.batch, year});
  return { ...data, ref, hash };
}

/* STORAGE load/save with seeds */
function loadRecords(){
  const raw = localStorage.getItem(STORE_KEY);
  if(raw){
    try{
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) return arr;
    }catch{}
  }

  const seededRaw = [
    {
      producer:"Proje Canakkale", code:"TR-17-001",
      product:"Ezine Peyniri", batch:"EZ-2026-01",
      place:"Ezine / √áanakkale",
      stt:"02.03.2027",
      prodDate:"15.03.2026",
      packDate:"20.12.2026",
      sheep:40, goat:42, cow:18,
      months:9,
      finalizedAt:"20.12.2026 10:32",
    },
    {
      producer:"Kazdaƒüƒ± Mandƒ±ra", code:"TR-17-002",
      product:"Tulum Peyniri", batch:"KD-2026-03",
      place:"Bayrami√ß / √áanakkale",
      stt:"10.02.2027",
      prodDate:"10.09.2026",
      packDate:"12.04.2027",
      sheep:40, goat:41, cow:19,
      months:7,
      finalizedAt:"12.04.2027 09:10",
    },
    {
      producer:"√áanakkale Peynir Koop.", code:"TR-17-003",
      product:"Beyaz Peynir", batch:"CK-2026-02",
      place:"Merkez / √áanakkale",
      stt:"01.01.2027",
      prodDate:"05.05.2026",
      packDate:"05.02.2027",
      sheep:50, goat:40, cow:10,
      months:9,
      finalizedAt:"05.02.2027 15:44",
    },
    {
      producer:"Gelibolu S√ºt √úr√ºnleri", code:"TR-17-004",
      product:"Koyun Peyniri", batch:"GL-2026-04",
      place:"Gelibolu / √áanakkale",
      stt:"18.03.2027",
      prodDate:"01.08.2026",
      packDate:"15.05.2027",
      sheep:35, goat:44, cow:25,
      months:9,
      finalizedAt:"15.05.2027 11:05",
    }
  ];

  const seeded = seededRaw.map(x => {
    const totalMilk = (Number.isFinite(x.sheep) && Number.isFinite(x.goat) && Number.isFinite(x.cow))
      ? (x.sheep + x.goat + x.cow) : null;

    const res = evaluateRules({
      prodDateTR: x.prodDate,
      prodDate: parseFlexibleDate(x.prodDate),
      packDate: parseFlexibleDate(x.packDate),
      months: x.months,
      sheep: x.sheep,
      goat: x.goat,
      cow: x.cow,
      total: totalMilk ?? 0,
      milkAny: true
    });

    return makeRecord({
      ...x,
      totalMilk,
      status: res.status,
      reasonsBad: res.reasonsBad,
      reasonsOk: res.reasonsOk,
      totalWarning: res.totalWarning,
      seasonOk: res.seasonOk
    });
  });

  localStorage.setItem(STORE_KEY, JSON.stringify(seeded));
  return seeded;
}
function saveRecords(){ localStorage.setItem(STORE_KEY, JSON.stringify(records)); }

/* PRODUCER FLOW */
function lockProducerInputs(locked){
  const ids = [
    "pProduct","pBatch","pPlace","pSttText",
    "pProdDateText","pPackDateText",
    "pSheep","pGoat","pCow"
  ];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.readOnly = locked;
    if(el.type === "number") el.disabled = locked;
  });

  document.querySelectorAll(".dateIconBtn").forEach(b=>{
    b.disabled = locked;
    b.style.opacity = locked ? "0.55" : "1";
    b.style.cursor = locked ? "not-allowed" : "pointer";
  });

  const btn = document.getElementById("finalizeBtn");
  btn.disabled = locked;
  btn.style.opacity = locked ? "0.55" : "1";
  btn.style.cursor = locked ? "not-allowed" : "pointer";
}

function resetProducerForm(){
  const clearIds = [
    "pProduct","pBatch","pPlace",
    "pSttText","pSttPicker",
    "pProdDateText","pProdDatePicker",
    "pPackDateText","pPackDatePicker",
    "pSheep","pGoat","pCow",
    "pMonths","pTotalMilk"
  ];
  clearIds.forEach(id => {
    const el = document.getElementById(id);
    if(el){ el.value = ""; if(el.type==="number") el.disabled = false; }
  });

  document.getElementById("producerResult").innerHTML = "";
  document.getElementById("liveChips").innerHTML = "";
  lockProducerInputs(false);
}

function finalizeRecord(){
  const producer = document.getElementById("pName").value.trim();
  const code = document.getElementById("pCode").value.trim();
  const product = document.getElementById("pProduct").value.trim();
  const batch = document.getElementById("pBatch").value.trim();
  const place = document.getElementById("pPlace").value.trim();
  const stt = document.getElementById("pSttText").value.trim();
  const prodTR = document.getElementById("pProdDateText").value.trim();
  const packTR = document.getElementById("pPackDateText").value.trim();

  const prodDate = parseFlexibleDate(prodTR);
  const packDate = parseFlexibleDate(packTR);

  const sheep = parseFloat(document.getElementById("pSheep").value);
  const goat  = parseFloat(document.getElementById("pGoat").value);
  const cow   = parseFloat(document.getElementById("pCow").value);

  if(!product || !batch || !place){
    alert("L√ºtfen √úr√ºn Adƒ±, Parti No ve √úretim Yeri alanlarƒ±nƒ± doldurun.");
    return;
  }
  if(!prodDate || !packDate){
    alert("L√ºtfen √úretim Tarihi ve Paketleme Tarihi girin (gg.aa.yyyy).");
    return;
  }
  if(!stt || !parseFlexibleDate(stt)){
    alert("L√ºtfen STT (Son T√ºketim Tarihi) girin (gg.aa.yyyy).");
    return;
  }
  if(!Number.isFinite(sheep) || !Number.isFinite(goat) || !Number.isFinite(cow)){
    alert("L√ºtfen s√ºt oranlarƒ±nƒ± sayƒ±sal olarak girin (Koyun/Ke√ßi/ƒ∞nek).");
    return;
  }

  const months = calcMonths();
  const milk = calcMilkTotal();

  const res = evaluateRules({
    prodDateTR: prodTR,
    prodDate,
    packDate,
    months,
    sheep, goat, cow,
    total: milk.total,
    milkAny: true
  });

  const finalizedAt = new Date().toLocaleString("tr-TR");

  const rec = makeRecord({
    producer, code, product, batch, place,
    stt,
    prodDate: prodTR,
    packDate: packTR,
    sheep, goat, cow,
    totalMilk: milk.total,
    months,
    seasonOk: res.seasonOk,
    status: res.status,
    reasonsBad: res.reasonsBad,
    reasonsOk: res.reasonsOk,
    totalWarning: res.totalWarning,
    finalizedAt
  });

  records.unshift(rec);
  saveRecords();
  lockProducerInputs(true);

  const cls = (rec.status === "Uygun") ? "ok" : "bad";
  const headline =
    rec.status === "Uygun"
    ? "‚úÖ Kayƒ±t ba≈üarƒ±yla tamamlandƒ± (Uygun)"
    : "‚úÖ Kayƒ±t tamamlandƒ± (Uygunsuz)";

  const badList = rec.reasonsBad.length
    ? `<div style="margin-top:10px"><strong>Nedenler:</strong><ul style="margin:8px 0 0 18px">${rec.reasonsBad.map(x=>`<li>‚ùå ${escapeHtml(x)}</li>`).join("")}</ul></div>`
    : `<div style="margin-top:10px"><strong>Sonu√ß:</strong> T√ºm otomatik deƒüerlendirme kurallarƒ± saƒülanmƒ±≈ütƒ±r.</div>`;

  const warn = rec.totalWarning
    ? `<div class="small" style="margin-top:10px">‚ö†Ô∏è ${escapeHtml(rec.totalWarning)}</div>`
    : "";

  document.getElementById("producerResult").innerHTML = `
    <div class="statusBox ${cls}">
      ${headline}<br>
      <span class="muted">Referans:</span> ${rec.ref} &nbsp;|&nbsp;
      <span class="muted">Hash:</span> ${rec.hash}<br>
      <span class="muted">Olgunla≈üma:</span> ${rec.months} ay &nbsp;|&nbsp;
      <span class="muted">Sezon:</span> ${(rec.seasonOk===true?"Mart‚ÄìAƒüustos":(rec.seasonOk===false?"Sezon dƒ±≈üƒ±":"-"))}
      ${badList}
      ${warn}
      <div class="actionsRow">
        <button class="btn-primary btn-inline" onclick="resetProducerForm()">‚ûï Yeni √ºr√ºn / yeni parti ekle</button>
        <button class="btn-ghost btn-inline" onclick="openModalByRef('${rec.ref.replaceAll("'","")}')">Detay G√∂r</button>
      </div>
    </div>
  `;
}

/* STATE TABLE */
function renderTable(){
  const q = (document.getElementById("q")?.value || "").toLowerCase();
  const sf = document.getElementById("statusFilter")?.value || "";
  const af = document.getElementById("ageFilter")?.value || "";
  const sez = document.getElementById("seasonFilter")?.value || "";

  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";
  let shown = 0;

  records.forEach(r => {
    const hay = `${r.producer} ${r.code} ${r.product} ${r.batch} ${r.ref} ${r.hash} ${r.place} ${r.stt}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(sf && r.status !== sf) return;
    if(af==="lt8" && !(Number.isFinite(r.months) && r.months < 8)) return;
    if(af==="gte8" && !(Number.isFinite(r.months) && r.months >= 8)) return;
    if(sez==="in" && r.seasonOk !== true) return;
    if(sez==="out" && r.seasonOk !== false) return;

    const tr = document.createElement("tr");
    tr.onclick = () => openDetailModal(r);

    tr.innerHTML = `
      <td data-label="Referans">
        <div class="stackRight">
          <div class="line1"><strong>${escapeHtml(r.ref)}</strong></div>
          <div class="line2">${escapeHtml(r.hash)}</div>
        </div>
      </td>

      <td data-label="√úretici">
        <div class="stackRight">
          <div class="line1">${escapeHtml(r.producer)}</div>
          <div class="line2">${escapeHtml(r.code)}</div>
        </div>
      </td>

      <td data-label="√úr√ºn"><span class="oneLineRight">${escapeHtml(r.product)}</span></td>
      <td data-label="Parti"><span class="oneLineRight">${escapeHtml(r.batch)}</span></td>
      <td data-label="√úretim Yeri"><span class="oneLineRight">${escapeHtml(r.place || "-")}</span></td>
      <td data-label="√úretim"><span class="oneLineRight">${escapeHtml(r.prodDate || "-")}</span></td>
      <td data-label="STT"><span class="oneLineRight">${escapeHtml(r.stt || "-")}</span></td>
      <td data-label="Ay"><span class="oneLineRight">${Number.isFinite(r.months)? r.months : "-"}</span></td>
      <td data-label="Durum" class="${r.status==='Uygun'?'status-ok':'status-bad'}">
        <span class="oneLineRight">${escapeHtml(r.status)}</span>
      </td>
      <td data-label="Finalizasyon"><span class="oneLineRight">${escapeHtml(r.finalizedAt || "-")}</span></td>
    `;

    tbody.appendChild(tr);
    shown++;
  });

  document.getElementById("countInfo").textContent = `G√∂sterilen kayƒ±t: ${shown} / Toplam: ${records.length}`;
}

/* MODAL */
function openModalByRef(ref){
  const r = records.find(x => x.ref === ref);
  if(r) openDetailModal(r);
}

function openDetailModal(r){
  document.getElementById("modal").style.display = "flex";
  const statusClass = r.status === "Uygun" ? "ok" : "bad";

  const badList = (r.reasonsBad && r.reasonsBad.length)
    ? `<ul style="margin:8px 0 0 18px">${r.reasonsBad.map(x=>`<li>‚ùå ${escapeHtml(x)}</li>`).join("")}</ul>`
    : `<div class="small" style="margin-top:6px">T√ºm otomatik deƒüerlendirme kurallarƒ± saƒülanmƒ±≈ütƒ±r.</div>`;

  const okList = (r.reasonsOk && r.reasonsOk.length)
    ? `<ul style="margin:8px 0 0 18px">${r.reasonsOk.map(x=>`<li>‚úÖ ${escapeHtml(x)}</li>`).join("")}</ul>`
    : "";

  const warn = r.totalWarning
    ? `<div class="small" style="margin-top:10px">‚ö†Ô∏è ${escapeHtml(r.totalWarning)}</div>`
    : "";

  const totalMilk = Number.isFinite(r.totalMilk)
    ? r.totalMilk
    : (Number.isFinite(r.sheep)&&Number.isFinite(r.goat)&&Number.isFinite(r.cow) ? (r.sheep+r.goat+r.cow) : null);

  document.getElementById("modalContent").innerHTML = `
    <div class="modalHeader">
      <div>
        <h2>Kayƒ±t Detayƒ±</h2>
        <div class="small">Read-only ‚Äì manuel m√ºdahale yoktur.</div>
      </div>
      <button class="btn-ghost btn-inline" onclick="closeModal()">Kapat</button>
    </div>

    <div class="hr"></div>

    <div class="kv">
      <div class="k">Referans No</div><div class="v">${escapeHtml(r.ref)}</div>
      <div class="k">Hash</div><div class="v">${escapeHtml(r.hash)}</div>
      <div class="k">Durum</div><div class="v"><span class="${statusClass} statusBox" style="display:inline-block;padding:8px 12px;margin:0">${escapeHtml(r.status)}</span></div>
      <div class="k">Sezon</div><div class="v">${(r.seasonOk===true?"Mart‚ÄìAƒüustos":(r.seasonOk===false?"Sezon dƒ±≈üƒ±":"-"))}</div>
      <div class="k">Olgunla≈üma</div><div class="v">${Number.isFinite(r.months)?`${r.months} ay`:"-"}</div>
    </div>

    <div class="hr"></div>

    <div class="kv">
      <div class="k">√úretici</div><div class="v">${escapeHtml(r.producer)}</div>
      <div class="k">√úretici Kodu</div><div class="v">${escapeHtml(r.code)}</div>
      <div class="k">√úr√ºn</div><div class="v">${escapeHtml(r.product)}</div>
      <div class="k">Parti No</div><div class="v">${escapeHtml(r.batch)}</div>
      <div class="k">√úretim Yeri</div><div class="v">${escapeHtml(r.place || "-")}</div>
      <div class="k">√úretim Tarihi</div><div class="v">${escapeHtml(r.prodDate || "-")}</div>
      <div class="k">Paketleme Tarihi</div><div class="v">${escapeHtml(r.packDate || "-")}</div>
      <div class="k">STT</div><div class="v">${escapeHtml(r.stt || "-")}</div>
      <div class="k">S√ºt Oranlarƒ±</div>
      <div class="v">Koyun: ${safeNum(r.sheep)}% ‚Ä¢ Ke√ßi: ${safeNum(r.goat)}% ‚Ä¢ ƒ∞nek: ${safeNum(r.cow)}% (Toplam: ${totalMilk==null?"-":totalMilk}%)</div>
      <div class="k">Finalizasyon</div><div class="v">${escapeHtml(r.finalizedAt || "-")}</div>
    </div>

    <div class="hr"></div>

    <div>
      <strong>Otomatik Deƒüerlendirme Sonu√ßlarƒ±</strong>
      ${badList}
      ${okList ? `<div style="margin-top:10px"><strong>Saƒülanan Kurallar</strong>${okList}</div>` : ""}
      ${warn}
    </div>
  `;
}
function closeModal(){ document.getElementById("modal").style.display = "none"; }

/* EXPORT CSV */
function exportCSV(){
  const q = (document.getElementById("q")?.value || "").toLowerCase();
  const sf = document.getElementById("statusFilter")?.value || "";
  const af = document.getElementById("ageFilter")?.value || "";
  const sez = document.getElementById("seasonFilter")?.value || "";

  const rows = [];
  rows.push([
    "Referans","Hash","Uretici","UreticiKodu","Urun","PartiNo","UretimYeri",
    "UretimTarihi","PaketlemeTarihi","STT",
    "Koyun","Keci","Inek","Toplam","Ay","Sezon","Durum","Nedenler","Finalizasyon"
  ]);

  records.forEach(r=>{
    const hay = `${r.producer} ${r.code} ${r.product} ${r.batch} ${r.ref} ${r.hash} ${r.place} ${r.stt}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(sf && r.status !== sf) return;
    if(af==="lt8" && !(Number.isFinite(r.months) && r.months < 8)) return;
    if(af==="gte8" && !(Number.isFinite(r.months) && r.months >= 8)) return;
    if(sez==="in" && r.seasonOk !== true) return;
    if(sez==="out" && r.seasonOk !== false) return;

    const nedenler = (r.reasonsBad && r.reasonsBad.length) ? r.reasonsBad.join(" | ") : "‚Äî";
    const sezonTxt = (r.seasonOk===true?"Mart‚ÄìAƒüustos":(r.seasonOk===false?"Sezon dƒ±≈üƒ±":"-"));
    const totalMilk = Number.isFinite(r.totalMilk) ? r.totalMilk : (Number.isFinite(r.sheep)&&Number.isFinite(r.goat)&&Number.isFinite(r.cow) ? (r.sheep+r.goat+r.cow) : "");

    rows.push([
      r.ref, r.hash, r.producer, r.code, r.product, r.batch, r.place,
      r.prodDate, r.packDate, r.stt,
      r.sheep, r.goat, r.cow, totalMilk, r.months, sezonTxt, r.status, nedenler, r.finalizedAt
    ]);
  });

  const csv = rows.map(r => r.map(cell => {
    const s = String(cell ?? "");
    if(s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
    return s;
  }).join(",")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `proje_canakkale_kayitlar_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ‚úÖ EXPORT PDF (direct download) */
function exportPDF(){
  if(!window.jspdf || !window.jspdf.jsPDF){
    alert("PDF k√ºt√ºphanesi y√ºklenemedi. L√ºtfen internet baƒülantƒ±sƒ±nƒ± kontrol edin.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });

  const q = (document.getElementById("q")?.value || "").toLowerCase();
  const sf = document.getElementById("statusFilter")?.value || "";
  const af = document.getElementById("ageFilter")?.value || "";
  const sez = document.getElementById("seasonFilter")?.value || "";

  const filtered = records.filter(r=>{
    const hay = `${r.producer} ${r.code} ${r.product} ${r.batch} ${r.ref} ${r.hash} ${r.place} ${r.stt}`.toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(sf && r.status !== sf) return false;
    if(af==="lt8" && !(Number.isFinite(r.months) && r.months < 8)) return false;
    if(af==="gte8" && !(Number.isFinite(r.months) && r.months >= 8)) return false;
    if(sez==="in" && r.seasonOk !== true) return false;
    if(sez==="out" && r.seasonOk !== false) return false;
    return true;
  });

  doc.setFontSize(14);
  doc.text("Proje √áanakkale ‚Äì Devlet ƒ∞zleme Raporu", 40, 40);
  doc.setFontSize(10);
  doc.text(`Olu≈üturma: ${new Date().toLocaleString("tr-TR")}`, 40, 58);

  const head = [[ "Referans","Hash","√úretici","Kod","√úr√ºn","Parti","Yer","√úretim","STT","Ay","Durum" ]];
  const body = filtered.map(r=>[
    r.ref,
    r.hash,
    r.producer,
    r.code,
    r.product,
    r.batch,
    r.place || "-",
    r.prodDate || "-",
    r.stt || "-",
    (Number.isFinite(r.months)? r.months : "-"),
    r.status
  ]);

  doc.autoTable({
    head,
    body,
    startY: 72,
    styles: { fontSize: 8, cellPadding: 3 },
    headStyles: { fillColor: [243,244,246] }
  });

  doc.save(`proje_canakkale_rapor_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* helpers */
function safeNum(n){ return Number.isFinite(n) ? n : "-"; }
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#39;");
}

/* keep sync across tabs */
window.addEventListener("storage", () => {
  records = loadRecords();
  if(document.getElementById("stateView").style.display !== "none"){
    renderTable();
  }
});
</script>

</body>
</html>
