<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Proje √áanakkale ‚Äì Demo (√úretici + Devlet)</title>

<style>
  :root{
    --bg:#f6f7f9;
    --card:#ffffff;
    --text:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --accent:#0f3d5e;
    --danger:#b91c1c;
    --ok:#065f46;
    --bad:#7f1d1d;
    --warnbg:#fff7ed;
    --warnline:#fed7aa;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --radius:16px;
  }
  *{box-sizing:border-box}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    margin:0;
    padding:40px;
    color:var(--text);
  }
  .card{
    max-width:1100px;
    margin:0 auto 18px auto;
    background:var(--card);
    border-radius:var(--radius);
    padding:32px;
    box-shadow:var(--shadow);
  }
  h1{margin:0 0 6px 0; letter-spacing:-.2px}
  .sub{color:var(--muted);margin:0 0 18px 0}

  label{display:block;margin-top:14px;font-weight:650}

  input, select{
    width:100%;
    padding:10px 12px;
    margin-top:6px;
    border:1px solid var(--line);
    border-radius:10px;
    font-size:14px;
    background:#fff;
    color:var(--text);
  }
  input[readonly]{background:#f3f4f6}

  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:820px){
    .row{grid-template-columns:1fr}
    body{padding:18px}
    .card{padding:22px}
  }

  button{
    margin-top:18px;
    padding:12px 14px;
    border:none;
    border-radius:12px;
    font-size:15px;
    font-weight:750;
    cursor:pointer;
  }
  .btn-primary{background:var(--accent);color:#fff;width:100%}
  .btn-danger{background:var(--danger);color:#fff;width:100%}
  .btn-ghost{background:#eef2f7;color:#111827}
  .btn-inline{width:auto}

  .topbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-bottom:8px;
  }

  .pill{
    display:flex;
    align-items:center;
    gap:10px;
    background:#eef2ff;
    color:#1f2a44;
    padding:10px 14px;
    border-radius:999px;
    line-height:1.1;
    font-weight:750;
    font-size:13px;
    white-space:nowrap;
  }
  .pill svg{width:18px;height:18px;flex:0 0 18px}
  .pill .meta{display:flex;flex-direction:column;gap:2px}
  .pill .meta .k{font-size:11px;color:#4b5563;font-weight:800;letter-spacing:.2px}
  .pill .meta .v{font-size:13px;color:#111827;font-weight:800}

  .note{
    margin-top:14px;
    background:var(--warnbg);
    border:1px solid var(--warnline);
    padding:12px 14px;
    border-radius:12px;
    font-size:14px;
  }
  .statusBox{
    margin-top:16px;
    padding:14px;
    border-radius:12px;
    font-weight:750;
  }
  .ok{background:#dcfce7;color:var(--ok)}
  .bad{background:#fee2e2;color:var(--bad)}
  .muted{color:var(--muted)}
  .actionsRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center}

  .filters{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
  .filters input, .filters select{width:auto;min-width:220px}
  table{width:100%;border-collapse:collapse;margin-top:16px}
  th, td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
  th{background:#f3f4f6}
  tr:hover{background:#f9fafb;cursor:pointer}
  .status-ok{color:var(--ok);font-weight:800}
  .status-bad{color:var(--bad);font-weight:800}

  .modal{
    position:fixed;inset:0;
    background:rgba(0,0,0,.42);
    display:none;
    align-items:center;
    justify-content:center;
    padding:18px;
    z-index:50;
  }
  .modalContent{
    background:#fff;
    width:100%;
    max-width:720px;
    border-radius:16px;
    padding:22px;
    box-shadow:0 20px 50px rgba(0,0,0,.18);
  }
  .modalHeader{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .modalHeader h2{margin:0}
  .hr{height:1px;background:var(--line);margin:14px 0}
  .kv{display:grid;grid-template-columns:220px 1fr;gap:8px 12px}
  @media (max-width:720px){ .kv{grid-template-columns:1fr} }
  .k{color:var(--muted);font-weight:650}
  .v{font-weight:650}
  .small{font-size:12px;color:var(--muted)}
  .rightActions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

  /* ‚úÖ Date field: icon INSIDE the input (like native) */
  .dateWrap{
    position:relative;
    margin-top:6px;      /* because label already has spacing */
  }
  .dateWrap input[type="text"]{
    margin-top:0;
    padding-right:44px;  /* space for icon */
  }
  .dateIconBtn{
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    width:28px;
    height:28px;
    border:none;
    background:transparent;
    padding:0;
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    border-radius:8px;
  }
  .dateIconBtn:hover{ background:#f3f4f6; }
  .dateIconBtn:active{ background:#e5e7eb; }
  .dateIconBtn svg{ width:18px;height:18px; stroke:var(--muted); }

  .hiddenDate{
    position:absolute;
    width:1px;height:1px;
    opacity:0;
    pointer-events:none;
  }
</style>
</head>

<body>

<!-- LOGIN -->
<div class="card" id="loginView">
  <div class="topbar">
    <div>
      <h1>Giri≈ü</h1>
      <p class="sub">Demo ama√ßlƒ± rol bazlƒ± giri≈ü (√úretici / Devlet).</p>
    </div>
    <div class="pill" aria-label="Proje √áanakkale">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3 3-7z"/>
      </svg>
      <div class="meta">
        <div class="k">PROJE</div>
        <div class="v">√áanakkale</div>
      </div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>Kullanƒ±cƒ± Kodu</label>
      <input id="loginCode" placeholder="√ñrn: TR-17-001 veya DEVLET" />
    </div>
    <div>
      <label>≈ûifre</label>
      <input id="loginPw" type="password" placeholder="≈ûifre" />
    </div>
  </div>

  <button class="btn-primary" onclick="doLogin()">Giri≈ü</button>

  <div class="note">
    <strong>Login:</strong><br>
    √úretici: <code>TR-17-001</code> / <code>Ezine</code><br>
    Devlet: <code>DEVLET</code> / <code>Devlet</code>
  </div>
</div>

<!-- PRODUCER VIEW -->
<div class="card" id="producerView" style="display:none">
  <div class="topbar">
    <div>
      <h1>√úretici Kayƒ±t Merkezi</h1>
      <p class="sub">Paketleme tamamla i≈üleminden sonra kayƒ±t kilitlenir ve deƒüi≈ütirilemez.</p>
    </div>
    <div class="rightActions">
      <div class="pill" id="producerPill">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21a8 8 0 0 0-16 0"/>
          <circle cx="12" cy="7" r="4"/>
        </svg>
        <div class="meta">
          <div class="k">√úRETƒ∞Cƒ∞</div>
          <div class="v" id="producerNamePill">-</div>
        </div>
      </div>
      <button class="btn-ghost btn-inline" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úretici Adƒ±</label>
      <input id="pName" readonly />
    </div>
    <div>
      <label>√úretici Kodu</label>
      <input id="pCode" readonly />
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úr√ºn</label>
      <input id="pProduct" placeholder="√ñrn: Ezine Peyniri" />
    </div>
    <div>
      <label>Parti No</label>
      <input id="pBatch" placeholder="√ñrn: EZ-2026-05" />
    </div>
  </div>

  <div class="row">
    <div>
      <label>√úretim Tarihi (gg.aa.yyyy)</label>
      <div class="dateWrap">
        <input
          id="pProdDateText"
          type="text"
          inputmode="numeric"
          placeholder="√ñrn: 05.01.2026"
          maxlength="10"
          oninput="handleDateTyping(this, 'pProdDatePicker'); calcMonths();"
          onblur="normalizeDateText(this, 'pProdDatePicker'); calcMonths();"
        />
        <input class="hiddenDate" id="pProdDatePicker" type="date"
               onchange="syncFromPicker('pProdDatePicker','pProdDateText'); calcMonths();" />
        <button type="button" class="dateIconBtn" onclick="openPicker('pProdDatePicker')" aria-label="Takvim">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M8 2v3M16 2v3"/>
            <path d="M3 8h18"/>
            <rect x="3" y="5" width="18" height="17" rx="2"/>
          </svg>
        </button>
      </div>
    </div>

    <div>
      <label>Paketleme Tarihi (gg.aa.yyyy)</label>
      <div class="dateWrap">
        <input
          id="pPackDateText"
          type="text"
          inputmode="numeric"
          placeholder="√ñrn: 05.02.2026"
          maxlength="10"
          oninput="handleDateTyping(this, 'pPackDatePicker'); calcMonths();"
          onblur="normalizeDateText(this, 'pPackDatePicker'); calcMonths();"
        />
        <input class="hiddenDate" id="pPackDatePicker" type="date"
               onchange="syncFromPicker('pPackDatePicker','pPackDateText'); calcMonths();" />
        <button type="button" class="dateIconBtn" onclick="openPicker('pPackDatePicker')" aria-label="Takvim">
          <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
            <path d="M8 2v3M16 2v3"/>
            <path d="M3 8h18"/>
            <rect x="3" y="5" width="18" height="17" rx="2"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <label>Olgunla≈ütƒ±rma S√ºresi (ay)</label>
  <input id="pMonths" readonly />

  <div class="note">
    ‚ö†Ô∏è <strong>Paketleme tamamla</strong> i≈üleminden sonra kayƒ±t kilitlenir.
  </div>

  <button class="btn-danger" id="finalizeBtn" onclick="finalizeRecord()">Paketleme tamamla</button>

  <div id="producerResult"></div>
</div>

<!-- STATE VIEW -->
<div class="card" id="stateView" style="display:none">
  <div class="topbar">
    <div>
      <h1>Devlet ƒ∞zleme Paneli</h1>
      <p class="sub">Veriler otomatik kurallara g√∂re olu≈üturulur. Manuel deƒüerlendirme / m√ºdahale yoktur.</p>
    </div>
    <div class="rightActions">
      <div class="pill" id="statePill">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 3l8 5v6c0 5-3.5 8-8 9-4.5-1-8-4-8-9V8l8-5z"/>
          <path d="M9 12l2 2 4-4"/>
        </svg>
        <div class="meta">
          <div class="k">KURUM</div>
          <div class="v">Devlet</div>
        </div>
      </div>
      <button class="btn-ghost btn-inline" onclick="logout()">√áƒ±kƒ±≈ü</button>
    </div>
  </div>

  <div class="filters">
    <input id="q" placeholder="Ara: √ºretici, √ºr√ºn, parti, referans" onkeyup="renderTable()" />
    <select id="statusFilter" onchange="renderTable()">
      <option value="">T√ºm Durumlar</option>
      <option value="Uygun">üü¢ Uygun</option>
      <option value="Uygunsuz">üî¥ Uygunsuz</option>
    </select>
    <select id="ageFilter" onchange="renderTable()">
      <option value="">T√ºm S√ºreler</option>
      <option value="lt12">&lt; 12 ay</option>
      <option value="gte12">‚â• 12 ay</option>
    </select>
  </div>

  <div class="actionsRow">
    <button class="btn-ghost btn-inline" onclick="exportCSV()">CSV Dƒ±≈üa Aktar</button>
    <button class="btn-ghost btn-inline" onclick="openPrintView()">PDF (Yazdƒ±r) ‚Äì Sim√ºlasyon</button>
    <span class="small">PDF i√ßin: Yazdƒ±r penceresinde ‚ÄúPDF olarak kaydet‚Äù.</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Referans</th>
        <th>√úretici</th>
        <th>√úr√ºn</th>
        <th>Parti</th>
        <th>Ay</th>
        <th>Durum</th>
        <th>Finalizasyon</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <p class="small muted" id="countInfo"></p>
</div>

<!-- DETAIL MODAL -->
<div class="modal" id="modal" onclick="if(event.target.id==='modal') closeModal()">
  <div class="modalContent" id="modalContent"></div>
</div>

<script>
/* USERS + STORAGE */
const USERS = [
  { code:"TR-17-001", pw:"Ezine",  role:"producer", name:"Proje Canakkale" },
  { code:"DEVLET",    pw:"Devlet", role:"state",    name:"Tarƒ±m ve Gƒ±da Otoritesi" }
];
const STORE_KEY = "pc_demo_records_v4";
let currentUser = null;
let records = loadRecords();

/* STATUS / HASH / REF */
function getStatus(months){
  if(months >= 12) return { text:"Uygun", class:"status-ok", rule:"Olgunla≈ütƒ±rma s√ºresi ‚â• 12 ay" };
  return { text:"Uygunsuz", class:"status-bad", rule:"Olgunla≈ütƒ±rma s√ºresi < 12 ay" };
}
function demoHash(str){
  let h = 0x811c9dc5;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = (h + ((h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24))) >>> 0;
  }
  return ("0000000" + h.toString(16)).slice(-8).toUpperCase();
}
function pad4(n){ return String(n).padStart(4,"0"); }
function buildReference({code, batch, finalizedAt}){
  const year = (finalizedAt && finalizedAt.slice(-4)) ? finalizedAt.slice(-4) : String(new Date().getFullYear());
  const short = code.replace("TR-","").replaceAll("-","");
  const seed = demoHash(code + "|" + batch + "|" + year);
  const seq = parseInt(seed.slice(-3), 16) % 10000;
  return `PC-${short}-${year}-${pad4(seq)}`;
}
function makeRecord({producer, code, product, batch, months, finalizedAt}){
  const status = getStatus(months);
  const payload = `${producer}|${code}|${product}|${batch}|${months}|${finalizedAt}`;
  const hash = demoHash(payload);
  const ref = buildReference({code, batch, finalizedAt});
  return { producer, code, product, batch, months, status:status.text, rule:status.rule, finalizedAt, ref, hash };
}

/* STORAGE */
function loadRecords(){
  const raw = localStorage.getItem(STORE_KEY);
  if(raw){
    try{
      const arr = JSON.parse(raw);
      if(Array.isArray(arr) && arr.length) return arr;
    }catch{}
  }
  const seeded = [
    makeRecord({ producer:"Proje Canakkale", code:"TR-17-001", product:"Ezine Peyniri", batch:"EZ-2026-01", months:14, finalizedAt:"14.01.2026 10:32" }),
    makeRecord({ producer:"Kazdaƒüƒ± Mandƒ±ra", code:"TR-17-002", product:"Tulum Peyniri", batch:"KD-2026-03", months:8,  finalizedAt:"11.01.2026 09:10" }),
    makeRecord({ producer:"√áanakkale Peynir Koop.", code:"TR-17-003", product:"Beyaz Peynir", batch:"CK-2026-02", months:6,  finalizedAt:"08.01.2026 15:44" }),
    makeRecord({ producer:"Gelibolu S√ºt √úr√ºnleri", code:"TR-17-004", product:"Koyun Peyniri", batch:"GL-2026-04", months:12, finalizedAt:"16.01.2026 11:05" })
  ];
  localStorage.setItem(STORE_KEY, JSON.stringify(seeded));
  return seeded;
}
function saveRecords(){ localStorage.setItem(STORE_KEY, JSON.stringify(records)); }

/* AUTH */
function doLogin(){
  const c = document.getElementById("loginCode").value.trim();
  const p = document.getElementById("loginPw").value;
  const u = USERS.find(x => x.code === c && x.pw === p);
  if(!u){ alert("Hatalƒ± giri≈ü"); return; }
  currentUser = u;
  document.getElementById("loginView").style.display = "none";
  if(u.role === "producer"){
    document.getElementById("producerView").style.display = "block";
    document.getElementById("pName").value = u.name;
    document.getElementById("pCode").value = u.code;
    document.getElementById("producerNamePill").textContent = u.name;
    resetProducerForm();
  }else{
    document.getElementById("stateView").style.display = "block";
    renderTable();
  }
}
function logout(){
  currentUser = null;
  document.getElementById("loginCode").value = "";
  document.getElementById("loginPw").value = "";
  document.getElementById("producerView").style.display = "none";
  document.getElementById("stateView").style.display = "none";
  document.getElementById("loginView").style.display = "block";
}

/* DATE: typing digits -> auto dots, keep picker */
function openPicker(pickerId){
  const el = document.getElementById(pickerId);
  if(!el) return;
  if(typeof el.showPicker === "function") el.showPicker();
  else { el.focus(); el.click(); }
}

function handleDateTyping(textEl, pickerId){
  let digits = textEl.value.replace(/\D/g,"").slice(0,8); // ddmmyyyy
  let out = "";
  if(digits.length <= 2) out = digits;
  else if(digits.length <= 4) out = digits.slice(0,2) + "." + digits.slice(2);
  else out = digits.slice(0,2) + "." + digits.slice(2,4) + "." + digits.slice(4);
  textEl.value = out;

  const dt = parseTRDate(out);
  if(dt) document.getElementById(pickerId).value = toISODate(dt);
}

function normalizeDateText(textEl, pickerId){
  const dt = parseFlexibleDate(textEl.value);
  if(dt){
    textEl.value = toTRDate(dt);
    document.getElementById(pickerId).value = toISODate(dt);
  }
}

function parseTRDate(s){
  const m = String(s||"").trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
  if(!m) return null;
  const d = +m[1], mo = +m[2], y = +m[3];
  const dt = new Date(y, mo-1, d);
  if(dt.getFullYear()===y && (dt.getMonth()+1)===mo && dt.getDate()===d) return dt;
  return null;
}

function parseFlexibleDate(s){
  if(!s) return null;
  const v = String(s).trim();
  let m = v.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    const dt=new Date(y, mo-1, d);
    if(dt.getFullYear()===y && (dt.getMonth()+1)===mo && dt.getDate()===d) return dt;
    return null;
  }
  return parseTRDate(v);
}

function toTRDate(dt){
  const dd = String(dt.getDate()).padStart(2,"0");
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const yy = dt.getFullYear();
  return `${dd}.${mm}.${yy}`;
}
function toISODate(dt){
  const yy = dt.getFullYear();
  const mm = String(dt.getMonth()+1).padStart(2,"0");
  const dd = String(dt.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}
function syncFromPicker(pickerId, textId){
  const p = document.getElementById(pickerId).value; // yyyy-mm-dd
  const dt = parseFlexibleDate(p);
  if(dt) document.getElementById(textId).value = toTRDate(dt);
}

/* PRODUCER FLOW */
function calcMonths(){
  const prod = parseFlexibleDate(document.getElementById("pProdDateText").value);
  const pack = parseFlexibleDate(document.getElementById("pPackDateText").value);
  if(!prod || !pack){
    document.getElementById("pMonths").value = "";
    return;
  }
  const months = Math.floor((pack - prod) / (1000*60*60*24*30));
  document.getElementById("pMonths").value = months;
}

function finalizeRecord(){
  const product = document.getElementById("pProduct").value.trim();
  const batch = document.getElementById("pBatch").value.trim();
  const months = parseInt(document.getElementById("pMonths").value, 10);

  if(!product || !batch){
    alert("L√ºtfen √úr√ºn ve Parti No alanlarƒ±nƒ± doldurun.");
    return;
  }
  if(Number.isNaN(months)){
    alert("L√ºtfen tarihleri gg.aa.yyyy formatƒ±nda girin veya takvimden se√ßin.");
    return;
  }

  const now = new Date();
  const finalizedAt = now.toLocaleString("tr-TR");

  const rec = makeRecord({
    producer: document.getElementById("pName").value,
    code: document.getElementById("pCode").value,
    product, batch, months, finalizedAt
  });

  records.unshift(rec);
  saveRecords();
  lockProducerInputs(true);

  const cls = (rec.status === "Uygun") ? "ok" : "bad";
  document.getElementById("producerResult").innerHTML = `
    <div class="statusBox ${cls}">
      ‚úÖ Kayƒ±t ba≈üarƒ±yla tamamlandƒ±<br>
      <span class="muted">Durum:</span> ${rec.status} &nbsp;|&nbsp;
      <span class="muted">Referans:</span> ${rec.ref} &nbsp;|&nbsp;
      <span class="muted">Hash:</span> ${rec.hash}<br>
      <span class="muted">Kural:</span> ${rec.rule}
      <div class="actionsRow">
        <button class="btn-primary btn-inline" onclick="resetProducerForm()">‚ûï Yeni √ºr√ºn / yeni parti ekle</button>
        <button class="btn-ghost btn-inline" onclick="openModalByRef('${rec.ref.replaceAll("'","")}')">Detay G√∂r</button>
      </div>
    </div>
  `;
}

function lockProducerInputs(locked){
  const ids = ["pProduct","pBatch","pProdDateText","pPackDateText"];
  ids.forEach(id => document.getElementById(id).readOnly = locked);

  // disable icon buttons (so it feels ‚Äúlocked‚Äù)
  document.querySelectorAll(".dateIconBtn").forEach(b=>{
    b.disabled = locked;
    b.style.opacity = locked ? "0.55" : "1";
    b.style.cursor = locked ? "not-allowed" : "pointer";
  });

  document.getElementById("finalizeBtn").disabled = locked;
  document.getElementById("finalizeBtn").style.opacity = locked ? "0.55" : "1";
  document.getElementById("finalizeBtn").style.cursor = locked ? "not-allowed" : "pointer";
}

function resetProducerForm(){
  document.getElementById("pProduct").value = "";
  document.getElementById("pBatch").value = "";

  document.getElementById("pProdDateText").value = "";
  document.getElementById("pPackDateText").value = "";
  document.getElementById("pProdDatePicker").value = "";
  document.getElementById("pPackDatePicker").value = "";

  document.getElementById("pMonths").value = "";
  document.getElementById("producerResult").innerHTML = "";
  lockProducerInputs(false);
}

/* STATE TABLE */
function renderTable(){
  const q = (document.getElementById("q")?.value || "").toLowerCase();
  const sf = document.getElementById("statusFilter")?.value || "";
  const af = document.getElementById("ageFilter")?.value || "";

  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  let shown = 0;
  records.forEach(r => {
    const hay = `${r.producer} ${r.code} ${r.product} ${r.batch} ${r.ref} ${r.hash}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(sf && r.status !== sf) return;
    if(af==="lt12" && r.months >= 12) return;
    if(af==="gte12" && r.months < 12) return;

    const tr = document.createElement("tr");
    tr.onclick = () => openDetailModal(r);

    tr.innerHTML = `
      <td><strong>${r.ref}</strong><div class="small">${r.hash}</div></td>
      <td>${r.producer}<div class="small">${r.code}</div></td>
      <td>${r.product}</td>
      <td>${r.batch}</td>
      <td>${r.months}</td>
      <td class="${r.status==='Uygun'?'status-ok':'status-bad'}">${r.status}</td>
      <td>${r.finalizedAt}</td>
    `;
    tbody.appendChild(tr);
    shown++;
  });

  document.getElementById("countInfo").textContent = `G√∂sterilen kayƒ±t: ${shown} / Toplam: ${records.length}`;
}

function openModalByRef(ref){
  const r = records.find(x => x.ref === ref);
  if(r) openDetailModal(r);
}

function openDetailModal(r){
  document.getElementById("modal").style.display = "flex";
  const statusClass = r.status === "Uygun" ? "ok" : "bad";

  document.getElementById("modalContent").innerHTML = `
    <div class="modalHeader">
      <div>
        <h2>Kayƒ±t Detayƒ±</h2>
        <div class="small">Read-only ‚Äì manuel m√ºdahale yoktur.</div>
      </div>
      <button class="btn-ghost btn-inline" onclick="closeModal()">Kapat</button>
    </div>

    <div class="hr"></div>

    <div class="kv">
      <div class="k">Referans No</div><div class="v">${r.ref}</div>
      <div class="k">Hash</div><div class="v">${r.hash}</div>
      <div class="k">Durum</div><div class="v"><span class="${statusClass} statusBox" style="display:inline-block;padding:8px 12px;margin:0">${r.status}</span></div>
      <div class="k">Kural</div><div class="v">${r.rule}</div>
    </div>

    <div class="hr"></div>

    <div class="kv">
      <div class="k">√úretici</div><div class="v">${r.producer}</div>
      <div class="k">√úretici Kodu</div><div class="v">${r.code}</div>
      <div class="k">√úr√ºn</div><div class="v">${r.product}</div>
      <div class="k">Parti No</div><div class="v">${r.batch}</div>
      <div class="k">Olgunla≈ütƒ±rma S√ºresi</div><div class="v">${r.months} ay</div>
      <div class="k">Finalizasyon</div><div class="v">${r.finalizedAt}</div>
    </div>
  `;
}
function closeModal(){ document.getElementById("modal").style.display = "none"; }

/* EXPORTS */
function exportCSV(){
  const q = (document.getElementById("q")?.value || "").toLowerCase();
  const sf = document.getElementById("statusFilter")?.value || "";
  const af = document.getElementById("ageFilter")?.value || "";

  const rows = [];
  rows.push(["Referans","Hash","Uretici","UreticiKodu","Urun","PartiNo","Ay","Durum","Kural","Finalizasyon"]);

  records.forEach(r=>{
    const hay = `${r.producer} ${r.code} ${r.product} ${r.batch} ${r.ref} ${r.hash}`.toLowerCase();
    if(q && !hay.includes(q)) return;
    if(sf && r.status !== sf) return;
    if(af==="lt12" && r.months >= 12) return;
    if(af==="gte12" && r.months < 12) return;
    rows.push([r.ref, r.hash, r.producer, r.code, r.product, r.batch, r.months, r.status, r.rule, r.finalizedAt]);
  });

  const csv = rows.map(r => r.map(cell => {
    const s = String(cell ?? "");
    if(s.includes(",") || s.includes('"') || s.includes("\n")) return `"${s.replaceAll('"','""')}"`;
    return s;
  }).join(",")).join("\n");

  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `proje_canakkale_kayitlar_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function openPrintView(){
  const q = (document.getElementById("q")?.value || "").toLowerCase();
  const sf = document.getElementById("statusFilter")?.value || "";
  const af = document.getElementById("ageFilter")?.value || "";

  const filtered = records.filter(r=>{
    const hay = `${r.producer} ${r.code} ${r.product} ${r.batch} ${r.ref} ${r.hash}`.toLowerCase();
    if(q && !hay.includes(q)) return false;
    if(sf && r.status !== sf) return false;
    if(af==="lt12" && r.months >= 12) return false;
    if(af==="gte12" && r.months < 12) return false;
    return true;
  });

  const html = `
  <!doctype html>
  <html lang="tr">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Proje √áanakkale ‚Äì Rapor</title>
    <style>
      body{font-family:Arial, sans-serif; padding:24px; color:#111}
      h1{margin:0}
      .sub{color:#555; margin:6px 0 18px 0}
      table{width:100%; border-collapse:collapse; margin-top:12px}
      th,td{border:1px solid #ddd; padding:8px; font-size:12px; text-align:left; vertical-align:top}
      th{background:#f3f4f6}
      .small{font-size:11px;color:#555}
      .ok{color:#065f46;font-weight:700}
      .bad{color:#7f1d1d;font-weight:700}
      @media print { button{display:none} }
    </style>
  </head>
  <body>
    <h1>Proje √áanakkale ‚Äì Devlet ƒ∞zleme Raporu</h1>
    <div class="sub">
      Olu≈üturma: ${new Date().toLocaleString("tr-TR")}<br>
      Kriterler: ${sf || "T√ºm Durumlar"} / ${af || "T√ºm S√ºreler"} / Arama: ${(document.getElementById("q").value || "-")}
    </div>

    <button onclick="window.print()">Yazdƒ±r / PDF olarak kaydet</button>

    <table>
      <thead>
        <tr>
          <th>Referans</th>
          <th>Hash</th>
          <th>√úretici</th>
          <th>√úr√ºn</th>
          <th>Parti</th>
          <th>Ay</th>
          <th>Durum</th>
          <th>Finalizasyon</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(r=>`
          <tr>
            <td><strong>${r.ref}</strong></td>
            <td class="small">${r.hash}</td>
            <td>${r.producer}<div class="small">${r.code}</div></td>
            <td>${r.product}</td>
            <td>${r.batch}</td>
            <td>${r.months}</td>
            <td class="${r.status==="Uygun"?"ok":"bad"}">${r.status}</td>
            <td>${r.finalizedAt}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  </body>
  </html>
  `;

  const w = window.open("", "_blank");
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
}

/* INIT sync across tabs */
window.addEventListener("storage", () => {
  records = loadRecords();
  if(document.getElementById("stateView").style.display !== "none"){
    renderTable();
  }
});
</script>

</body>
</html>
